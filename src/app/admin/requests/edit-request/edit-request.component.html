<div *ngIf="!dataLoaded">Se încarcă...</div>
<div *ngIf="dataLoaded">
    <div fxLayout="row" fxLayoutAlign="start start">
      <div>
        <h1 style="display: inline-block;">
        Cererea # {{ sessionData.currentRequestId }}
        </h1>
      </div>
      <div style="padding: 20px;" fxFlex>
        <app-loading-button btnStyle="stroked" [loading]="statusChanging" [matMenuTriggerFor]="statusChange"
          [label]="dataService.getMetadataLabel('request_status_types', sessionData.currentRequest.status)">
        </app-loading-button>
        <mat-menu #statusChange="matMenu" xPosition="before">
          <button (click)="onChangeRequestStatus(k.id)"
            *ngFor="let k of dataService.metadata['request_status_types']" mat-menu-item>{{ k.label }}</button>
        </mat-menu>
        <span style="display: inline-block; padding: 0px 5px;">&nbsp;</span>

        <app-loading-button *ngIf="sessionData.currentRequest.assigned_user" (click)="onUnassign()" btnStyle="stroked" [loading]="assignChanging" icon="close" showIcon="hover"
          [label]="'Preluată de ' + sessionData.currentRequest.assigned_user.name ">
        </app-loading-button>
        <app-loading-button *ngIf="sessionData.currentRequest.assigned_user===null" (click)="onAssign()" btnStyle="stroked"
          [loading]="assignChanging"
          label="Preia cererea">
        </app-loading-button>
      </div>
    </div>
    <div class="page-container">
        <div class="edit-side">
            <mat-tab-group>
                <mat-tab label="Date cerere">
                    <ng-template matTabContent>
                    <div class="tab-content">
                        <app-edit-request-data></app-edit-request-data>
                    </div>
                    </ng-template>
                </mat-tab>
                <mat-tab label="Nevoi">
                    <ng-template matTabContent>
                        <app-edit-request-needs></app-edit-request-needs>
                    </ng-template>
                </mat-tab>
            </mat-tab-group>
        </div>
        <div class="preview-side">
            <div class="item">
              <div class="label">Cererea originală: <a (click)="showNeedsText=!showNeedsText">{{ showNeedsText ? "ascunde" : "arată" }}</a></div>
              <div *ngIf="showNeedsText" class="value" [innerHTML]="sessionData.currentRequest.needs_text | nl2br"></div>
            </div>
            <div class="item">
              <div class="label">Nevoi curente (agregate): </div>
              <div class="value">
                  <div class="change-need-row" *ngFor="let n of sessionData.currentRequest.current_needs" fxLayout="row"
                    fxLayoutAlign="space-between start" fxLayoutGap="5px">
                    <div>{{ dataService.getMetadataLabel('need_types', n.need_type_id) }}</div>
                    <div class="bottom-dots" fxFlex>&nbsp;</div>
                    <div>{{ n.quantity | number : '1.0-0' }}</div>
                  </div>
              </div>
            </div>
            <div class="item">
                <div class="label">Unitate: </div>
                <div class="value">{{ sessionData.currentRequest.medical_unit_name }}</div>
                <div class="value">{{ dataService.getMetadataLabel('medical_unit_types', sessionData.currentRequest.medical_unit_type_id) }}</div>
                <div class="value">{{ dataService.getMetadataLabel('counties', sessionData.currentRequest.county_id) }}</div>
            </div>
            <div class="item">
              <div class="label">Persoană: </div>
              <div class="value">{{ sessionData.currentRequest.name }}</div>
              <div class="value">{{ sessionData.currentRequest.job_title }}</div>
              <div class="value">{{ sessionData.currentRequest.phone_number }}</div>
            </div>
            <div class="item-list">
              <div class="label">Nevoi: </div>
              
              <!-- <div class="preview-need" *ngFor="let n of sessionData.currentRequest.needs">
                  <div class="need-name">{{ dataService.getMetadataLabel('needs', n.need_id) }}</div>
                  <div class="dots"></div>
                  <div class="need-quantity">{{ n.quantity }}</div>
              </div> -->
            </div>
            <div class="item">
              <div class="label">Preluată de: </div>
              <div class="value" *ngIf="sessionData.currentRequest.assigned_user">{{ sessionData.currentRequest.assigned_user.name }}</div>
            </div>
        </div>
    </div>
</div>